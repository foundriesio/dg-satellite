{{/* Used by the auth package's localProvider implementation */}}
{{ template "header" .}}
    <section class="content-section">
      <h2>{{.Title}}</h2>
      {{if .Message}}
      <section>
        <mark>{{.Message}}</mark>
      </section>
      {{end}}

      <form id="passwordChangeForm">
        <fieldset>
          <legend><strong>Current Password</strong></legend>
          <input type="password" name="currentPassword" id="currentPassword" required />
        </fieldset>
        
        <fieldset>
          <legend><strong>New Password</strong></legend>
          <input type="password" name="newPassword" id="newPassword" required />
        </fieldset>
        
        <fieldset>
          <legend><strong>Confirm New Password</strong></legend>
          <input type="password" name="confirmNewPassword" id="confirmNewPassword" required />
          <span id="passwordError" style="color: red; display: none;">Passwords do not match</span>
        </fieldset>

        <button type="submit">Change password</button>
      </form>
      
      <script>
        document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
          e.preventDefault();

          var newPassword = document.getElementById('newPassword').value;
          var confirmPassword = document.getElementById('confirmNewPassword').value;
          var errorSpan = document.getElementById('passwordError');
          
          if (newPassword !== confirmPassword) {
            errorSpan.style.display = 'inline';
            return false;
          }
          errorSpan.style.display = 'none';

          var currentPassword = document.getElementById('currentPassword').value;
          var formData = new FormData();
          formData.append('currentPassword', currentPassword);
          formData.append('newPassword', newPassword);

          fetch('/users/{{.User.Username}}/password', {
            method: 'POST',
            body: formData
          })
          .then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              return response.text().then(errorText => {
                throw new Error(errorText || 'HTTP ' + response.status + ': ' + response.statusText);
              });
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Failed to change password: ' + error.message);
          });
        });

        // Show error on input change
        document.getElementById('confirmNewPassword').addEventListener('input', function() {
          var newPassword = document.getElementById('newPassword').value;
          var confirmPassword = this.value;
          var errorSpan = document.getElementById('passwordError');
          
          if (confirmPassword && newPassword !== confirmPassword) {
            errorSpan.style.display = 'inline';
          } else {
            errorSpan.style.display = 'none';
          }
        });
      </script>
    </section>

{{ template "footer"}}
